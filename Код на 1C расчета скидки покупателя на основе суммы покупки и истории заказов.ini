// В модуле объекта "Покупатель"

Функция РассчитатьСкидку(СуммаПокупки) Экспорт
	
	Если СуммаПокупки > 10000 Тогда
		Возврат 0.15; // 15% скидка
	КонецЕсли;
	
	Если СуммаПокупки > 5000 Тогда
		Возврат 0.10; // 10% скидка
	КонецЕсли;
	
	// Проверка истории заказов
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Покупатели.Ссылка КАК Покупатель,
	|	КОЛИЧЕСТВО(Заказы.Ссылка) КАК КоличествоЗаказов
	|ИЗ
	|	Документ.Заказы КАК Заказы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Покупатели КАК Покупатели
	|		ПО Заказы.Покупатель = Покупатели.Ссылка
	|ГДЕ
	|	Покупатели.Ссылка = &Покупатель
	|";
	
	Запрос.УстановитьПараметр("Покупатель", Ссылка);
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Результат.КоличествоЗаказов > 10 Тогда
		Возврат 0.05; // 5% скидка за лояльность
	КонецЕсли;
	
	Возврат 0; // Скидки нет
	
КонецФункции