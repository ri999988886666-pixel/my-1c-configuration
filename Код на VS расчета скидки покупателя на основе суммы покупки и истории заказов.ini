/**
 * Рассчитывает скидку для покупателя на основе суммы покупки и истории заказов
 * @param purchaseSum - Сумма текущей покупки
 * @return Размер скидки в диапазоне от 0 до 0.15
 */
Function CalculateDiscount(purchaseSum) Export
    
    If purchaseSum > 10000 Then
        Return 0.15; // 15% discount
    EndIf;
    
    If purchaseSum > 5000 Then
        Return 0.10; // 10% discount
    EndIf;
    
    // Check order history
    Query = New Query;
    Query.Text = "
    |SELECT
    |    Customers.Ref AS Customer,
    |    COUNT(Orders.Ref) AS OrdersCount
    |FROM
    |    Document.Orders AS Orders
    |        INNER JOIN Catalog.Customers AS Customers
    |        ON Orders.Customer = Customers.Ref
    |WHERE
    |    Customers.Ref = &Customer
    |";
    
    Query.SetParameter("Customer", Ref);
    Result = Query.Execute().Choose();
    
    If Result.OrdersCount > 10 Then
        Return 0.05; // 5% loyalty discount
    EndIf;
    
    Return 0; // No discount
    
EndFunction